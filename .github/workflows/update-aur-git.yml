name: update-aur-git.yml
on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  update-aur-package:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Get commit hash and count
        id: get_commit_info
        run: |
          COMMIT_HASH=$(git rev-parse --short=7 HEAD)
          COMMIT_COUNT=$(git rev-list --count HEAD)
          VERSION="r${COMMIT_COUNT}.${COMMIT_HASH}"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "COMMIT_HASH=$COMMIT_HASH" >> $GITHUB_ENV
          echo "COMMIT_COUNT=$COMMIT_COUNT" >> $GITHUB_ENV
      - name: Generate PKGBUILD
        run: |
          cat > PKGBUILD << EOF
          pkgname=twintaillauncher-git
          _pkgname="\${pkgname%-git}"
          # pkgver generated by pkgver() function
          pkgrel=1
          pkgdesc='A multi-platform launcher for your anime games'
          arch=('x86_64')
          license=('GPL-3.0-only')
          url=https://github.com/TwintailTeam/TwintailLauncher
          depends=('cairo' 'desktop-file-utils' 'gdk-pixbuf2' 'glib2' 'gtk3' 'hicolor-icon-theme' 'pango' 'webkit2gtk-4.1' 'libappindicator-gtk3' 'libayatana-appindicator')
          makedepends=('git' 'openssl' 'appmenu-gtk-module' 'libappindicator-gtk3' 'librsvg' 'cargo' 'pnpm' 'nodejs')
          provides=("\${_pkgname}")
          conflicts=("\${_pkgname}" "twintaillauncher-bin")
          source=("\${_pkgname}::git+https://github.com/TwintailTeam/TwintailLauncher.git#branch=master")
          sha256sums=('SKIP')
          options=('!lto' '!debug')
  
          prepare() {
            cd "\$_pkgname"
            pnpm i
          }
  
          build() {
            cd "\$_pkgname"
            pnpm build:native --no-bundle
          }
  
          pkgver() {
            cd "\$_pkgname"
            printf "r%s.%s" "\$(git rev-list --count HEAD)" "\$(git rev-parse --short=7 HEAD)"
          }
          
          package() {
            install -Dm644 \$_pkgname/LICENSE -t \$pkgdir/usr/share/licenses/\$pkgname
            install -Dm755 \$_pkgname/src-tauri/target/release/resources/krpatchz -t \$pkgdir/usr/lib/twintaillauncher/resources/
            install -Dm755 \$_pkgname/src-tauri/target/release/resources/hpatchz -t \$pkgdir/usr/lib/twintaillauncher/resources/
            install -Dm755 \$_pkgname/src-tauri/target/release/resources/7zr -t \$pkgdir/usr/lib/twintaillauncher/resources/
            install -Dm755 \$_pkgname/src-tauri/target/release/twintaillauncher -t \$pkgdir/usr/bin
            install -Dm644 \$_pkgname/twintaillauncher.desktop -t \$pkgdir/usr/share/applications
            install -Dm644 \$_pkgname/src-tauri/icons/32x32.png \$pkgdir/usr/share/icons/hicolor/32x32/apps/\$_pkgname.png
            install -Dm644 \$_pkgname/src-tauri/icons/128x128.png \$pkgdir/usr/share/icons/hicolor/128x128/apps/\$_pkgname.png
            install -Dm644 \$_pkgname/src-tauri/icons/128x128@2x.png \$pkgdir/usr/share/icons/hicolor/256x256@2/apps/\$_pkgname.png
          }
          EOF
      - name: Test PKGBUILD
        uses: KSXGitHub/github-actions-deploy-aur@v3.0.1
        with:
          pkgname: twintaillauncher-git
          pkgbuild: ./PKGBUILD
          test: true
          commit_username: ${{ secrets.GIT_USER }}
          commit_email: ${{ secrets.GIT_EMAIL }}
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          commit_message: "Update to commit ${{ env.VERSION }}"
          ssh_keyscan_types: rsa,ecdsa,ed25519
      - name: Publish AUR package
        if: success()
        uses: KSXGitHub/github-actions-deploy-aur@v3.0.1
        with:
          pkgname: twintaillauncher-git
          pkgbuild: ./PKGBUILD
          commit_username: ${{ secrets.GIT_USER }}
          commit_email: ${{ secrets.GIT_EMAIL }}
          ssh_private_key: ${{ secrets.AUR_SSH_PRIVATE_KEY }}
          commit_message: "Update to commit ${{ env.VERSION }}"
          ssh_keyscan_types: rsa,ecdsa,ed25519
